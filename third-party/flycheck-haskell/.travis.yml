
language: generic

# Explicitly request container-based infrastructure.
sudo: false

cache:
  directories:
    - "$HOME/.cabal"
    - "$HOME/.emacs.d/.cask"

before_cache:
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/build-reports.log
  # remove files that are regenerated by 'cabal update'
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/00-index.*
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/*.json
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.cache
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar.idx

  - rm -rfv $HOME/.cabal/packages/head.hackage

# Speed up git.
git:
  depth: 5

matrix:
  allow_failures:
    - env: GHC=head CABALVER=head INSTALL_HPACK=0 HLINT=0 EVM_EMACS=emacs-25.3-travis
    - env: GHC=head CABALVER=head INSTALL_HPACK=1 HLINT=0 EVM_EMACS=emacs-25.3-travis

  include:
    - env: GHC=7.2.2 CABALVER=1.16 INSTALL_HPACK=0 HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 7.2.2, Cabal 1.16, EMACS 25.3"
      addons: {apt: {packages: [ghc-7.2.2, cabal-install-1.16], sources: [hvr-ghc]}}

    - env: GHC=7.4.2 CABALVER=1.16 INSTALL_HPACK=0 HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 7.4.2, Cabal 1.16, EMACS 25.3"
      addons: {apt: {packages: [ghc-7.4.2, cabal-install-1.16], sources: [hvr-ghc]}}

    - env: GHC=7.6.3 CABALVER=1.18 INSTALL_HPACK=0 HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 7.6.3, Cabal 1.18, EMACS 25.3"
      addons: {apt: {packages: [ghc-7.6.3, cabal-install-1.18], sources: [hvr-ghc]}}

    - env: GHC=7.8.4 CABALVER=1.20 INSTALL_HPACK=1 HPACK_CONSTRAINTS="--constraint=basement<0.0.11"HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 7.8.4, Cabal 1.20, EMACS 25.3"
      addons: {apt: {packages: [ghc-7.8.4, cabal-install-1.20], sources: [hvr-ghc]}}

    - env: GHC=7.10.3 CABALVER=1.22 INSTALL_HPACK=1 HPACK_CONSTRAINTS="--constraint=basement<0.0.11" HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 7.10.3, Cabal 1.22, EMACS 25.3"
      addons: {apt: {packages: [ghc-7.10.3, cabal-install-1.22], sources: [hvr-ghc]}}

    - env: GHC=8.0.2 CABALVER=1.24 INSTALL_HPACK=1 HPACK_VERSION=0.19.3 HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 8.0.2, Cabal 1.24, EMACS 25.3"
      addons: {apt: {packages: [ghc-8.0.2, cabal-install-1.24], sources: [hvr-ghc]}}

    - env: GHC=8.2.2 CABALVER=2.0 INSTALL_HPACK=1 HPACK_VERSION=0.28.2 HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 8.2.2, Cabal 2.0, EMACS 25.3"
      addons: {apt: {packages: [ghc-8.2.2, cabal-install-2.0], sources: [hvr-ghc]}}

    - env: GHC=8.4.3 CABALVER=2.2 INSTALL_HPACK=1 HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 8.4.3, Cabal 2.2, EMACS 25.3"
      addons: {apt: {packages: [ghc-8.4.3, cabal-install-2.2], sources: [hvr-ghc]}}

    - env: GHC=8.6.5 CABALVER=2.4 ALEXVER=3.2.4 HAPPYVER=1.19.12 INSTALL_HPACK=1 HLINT=1 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 8.6.5, Cabal 2.4, EMACS 25.3"
      addons: {apt: {packages: [ghc-8.6.5, cabal-install-2.4, alex-3.2.4, happy-1.19.12], sources: [hvr-ghc]}}

    - env: GHC=8.8.1 CABALVER=3.0 ALEXVER=3.2.4 HAPPYVER=1.19.12 INSTALL_HPACK=1 HLINT=1 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC 8.8.1, Cabal 3.0, EMACS 25.3"
      addons: {apt: {packages: [ghc-8.8.1, cabal-install-3.0, alex-3.2.4, happy-1.19.12], sources: [hvr-ghc]}}

    - env: GHC=head CABALVER=head INSTALL_HPACK=0 HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC HEAD, Cabal HEAD, EMACS 25.3, no hpack"
      addons: {apt: {packages: [ghc-head, cabal-install-head], sources: [hvr-ghc]}}

    - env: GHC=head CABALVER=head INSTALL_HPACK=1 HLINT=0 EVM_EMACS=emacs-25.3-travis
      compiler: "GHC HEAD, Cabal HEAD, EMACS 25.3, with hpack"
      addons: {apt: {packages: [ghc-head, cabal-install-head], sources: [hvr-ghc]}}

install: true

before_install:

  # Using compiler above sets CC to an invalid value, so unset it
  - unset CC

  - export PATH="/opt/ghc/$GHCVER/bin:/opt/cabal/$CABALVER/bin:$HOME/.cabal/bin:$PATH"

  - |
    if [ -n "$HAPPYVER" ]; then
      export PATH="/opt/happy/$HAPPYVER/bin:$PATH"
    fi
  - |
    if [ -n "$ALEXVER" ]; then
      export PATH="/opt/alex/$ALEXVER/bin:$PATH"
    fi

  - |
    if [ -n "$EVM_EMACS" ]; then
      git clone https://github.com/rejeep/evm.git $HOME/.evm
      export PATH="$HOME/.evm/bin:$PATH"
      evm config path /tmp
      evm install "$EVM_EMACS" --use --skip
      # Use cask to install elisp dependencies
      git clone https://github.com/cask/cask.git "$HOME/.cask"
      export PATH="$HOME/.cask/bin:$PATH"
    fi

install:
  - echo "$PATH"
  - echo "$(ghc --version) [$(ghc --print-project-git-commit-id 2> /dev/null || echo '?')]"
  - echo "$(ghc-pkg list)"
  - make compile
  - echo "Installing dependencies"
  - |
    if [ "$INSTALL_HPACK" = 1 ] || [ "$HLINT" = 1 ]; then
      travis_retry cabal update
    fi
  - |
    if [ "$INSTALL_HPACK" = 1 ]; then
      cabal install hsc2hs
      if [ -z "${HPACK_VERSION+x}" ]; then
        hpack="hpack"
      else
        hpack="hpack-$HPACK_VERSION"
      fi
      cabal install "$hpack" ${HPACK_CONSTRAINTS:-}
    fi
  - |
    if [ "$HLINT" = 1 ]; then
      cabal install hlint
    fi


script:
  - |
    if [ "$HLINT" = 1 ]; then
      make HLINTFLAGS=-c lint
    fi
  - make test
